I"ûp<blockquote>
  <p>CASåŸç†è§£æåŠæºç åˆ†æ</p>
</blockquote>

<h1 id="casé”">CASé”</h1>

<p>CASæ˜¯ä¸€ç§æ— é”ç®—æ³•ï¼›å®ƒçš„å…¨ç§°ï¼šCompare and Swapï¼ˆæ¯”è¾ƒå’Œäº¤æ¢ï¼‰</p>

<h3 id="ç®—æ³•æ€æƒ³">ç®—æ³•æ€æƒ³</h3>

<p>CASåœ¨æ“ä½œçš„è¿‡ç¨‹ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªå‚æ•°ï¼šä¸€ã€å†…å­˜ä¸­çš„å€¼V(å¯ä»¥ç†è§£ä¸ºå®é™…å½“å‰æ—¶åˆ»çœŸå®çš„å€¼)ï¼›äºŒã€æ—§å€¼A(å¯ä»¥ç†è§£ä¸ºä¸Šæ¬¡è®°å½•çš„ä¿®æ”¹çš„å€¼)ï¼›ä¸‰ã€è¦ä¿®æ”¹çš„æ–°å€¼B(å¯ä»¥ç†è§£ä¸ºéœ€è¦ä¿®æ”¹åçš„å€¼)</p>

<p>CASçš„æ•´ä½“æ€è·¯æ˜¯ï¼šå®ƒé¦–å…ˆä¼šå°†<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>ä¸<code class="language-plaintext highlighter-rouge">æ—§å€¼A</code>è¿›è¡Œæ¯”è¾ƒï¼›å¦‚æœä¸€æ ·å°±ä¼šå°†<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>ä¿®æ”¹ä¸º<code class="language-plaintext highlighter-rouge">è¦ä¿®æ”¹çš„æ–°å€¼B</code>ï¼›å¦‚æœä¸ä¸€æ ·åˆ™å°±è¯´æ˜åŒä¸€æ—¶åˆ»è¯¥å€¼è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œæ­¤æ—¶å°±ä»€ä¹ˆä¹Ÿä¸åšã€‚æ•´ä¸ªæ“ä½œéƒ½å±äºåŸå­æ“ä½œã€‚ï¼ˆä¸‹ä¸ªå¾ªç¯ç»§ç»­ï¼‰</p>

<p><strong>æ‹¿æ¡ˆä¾‹è¯´æ˜</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">Thread</span><span class="o">(()--&gt;{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="n">i</span><span class="o">++;</span>
<span class="o">})</span>
</code></pre></div></div>
<p>å‡è®¾æ­¤æ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹Aã€BåŒæ—¶æ‰§è¡Œä¸Šé¢ä»£ç ï¼›ä»–ä»¬ä¼šæœ‰å„è‡ªçš„å·¥ä½œå†…å­˜ï¼›çº¿ç¨‹Aã€Bç«äº‰ï¼Œå‡è®¾çº¿ç¨‹Aé¦–å…ˆè¯»å–å†…å­˜å€¼ï¼Œä¸å°±æ˜¯æ¯”è¾ƒç¬¦åˆé¢„æœŸï¼Œå³<code class="language-plaintext highlighter-rouge">10 == 10</code>ï¼›æ­¤æ—¶å°±æ˜¯å°†11æ›´æ–°åˆ°å†…å­˜ï¼›ä½†æ˜¯æ­¤æ—¶çº¿ç¨‹Bå·²ç»å°†10è¯»å…¥äº†å·¥ä½œå†…å­˜ï¼Œè¿™ä¸ªæ˜¯ä½œä¸ºæ—§å€¼ï¼Œæ­¤æ—¶å†ä¸å†…å­˜ä¸­çš„å€¼æ¯”è¾ƒä¼šå‘ç°<code class="language-plaintext highlighter-rouge">11 != 10</code>ï¼›è¯´æ˜å…±äº«æ•°æ®å·²ç»è¢«ä¿®æ”¹ï¼Œæ”¾å¼ƒå·²ç»æ‰€åšçš„æ“ä½œï¼Œç„¶åæ‹¿æ–°çš„å†…å­˜çš„ä½œä¸ºæ—§å€¼ï¼Œé‡æ–°æ‰§è¡Œåˆšæ‰çš„æ“ä½œã€‚ç›´è‡³ä¸‹ä¸€æ¬¡çš„é‡æ–°æ“ä½œåˆ™ä¼šæˆåŠŸä¿®æ”¹ï¼›</p>

<p><code class="language-plaintext highlighter-rouge">è®°ä½ï¼šCASè¿™é‡Œä¼šæœ‰ä¸ªä¸åœçš„å¾ªç¯è¿‡ç¨‹</code></p>

<h3 id="javaä¸­casçš„åº”ç”¨">Javaä¸­CASçš„åº”ç”¨</h3>

<p>åœ¨java.util.concurrent.atomicåŒ…ä¸‹æœ‰ä¸€ç³»åˆ—çš„ç±»ï¼Œè¿™äº›ç±»åŸºæœ¬ä¸Šéƒ½ä½¿ç”¨äº†CASï¼›</p>

<p>ä¸‹é¢æˆ‘ä»¬ä»¥AtomicIntegerè¿›è¡Œè¯´æ˜ï¼ˆä»£ç ä¸»è¦æ˜¯ä½¿ç”¨äº†20ä¸ªçº¿ç¨‹è¿›è¡Œè‡ªå¢10000æ¬¡æ¥è¯æ˜åŸå­æ€§.è¿è¡Œç»“æœæ˜¯ï¼š200000ï¼‰ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThread</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">AtomicInteger</span> <span class="n">race</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">THREADS_COUNT</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">increase</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">race</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">[</span><span class="no">THREADS_COUNT</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS_COUNT</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="n">increase</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">race</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//ç¨‹åºè¿è¡Œç»“æœä¸ºï¼š200000</span>
</code></pre></div></div>

<p>ç¨‹åºè¾“å‡ºæ­£ç¡®ç»“æœï¼Œä¸€åˆ‡éƒ½è¦å½’åŠŸäºAtomicIntegerçš„incrementAndGet()æ–¹æ³•çš„åŸå­æ€§ï¼Œè¯¥æ–¹æ³•æ— é™å¾ªç¯ï¼Œä¸æ–­å°è¯•å°†ä¸€ä¸ªä¸€ä¸ªæ¯”å½“å‰å€¼å¤§1çš„æ–°å€¼èµ‹ç»™è‡ªå·±ï¼Œå¦‚æœå¤±è´¥äº†é‚£è¯´æ˜åœ¨æ‰§è¡Œâ€œè·å–-è®¾ç½®â€œæ“ä½œçš„æ—¶å€™å€¼å·²ç»æœ‰äº†ä¿®æ”¹ï¼Œäºæ˜¯å†æ¬¡å¾ªç¯è¿›è¡Œä¸‹ä¸€æ¬¡æ“ä½œï¼Œåªå¸¦è®¾ç½®æˆåŠŸä¸ºæ­¢ï¼Œå®ƒçš„åŸç†å®ç°å…¶å®éå¸¸ç®€å•ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹AtomicIntegerçš„incrementAndGet()æ–¹æ³•çš„æºç ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">incrementAndGet</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">getAndAddInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>å®é™…è°ƒç”¨çš„æ˜¯unsafeçš„getAndAddIntæ–¹æ³•ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndAddInt</span><span class="o">(</span><span class="nc">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">long</span> <span class="n">var2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">var5</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="n">var5</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getIntVolatile</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">while</span><span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">,</span> <span class="n">var5</span><span class="o">,</span> <span class="n">var5</span> <span class="o">+</span> <span class="n">var4</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">var5</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç”±AtomicIntegeræºç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼›CASçš„å®ç°å°±æ˜¯Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ï¼›Unsafeä¸­çš„æ–¹æ³•éƒ½æ˜¯nativeæœ¬åœ°æ–¹æ³•ï¼›è¿™æ˜¯å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡ä»–å®ç°äº†åŸå­æ“ä½œã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ã€‚åŒæ ·è¿™ä¸ªå†…å­˜çš„å€¼valueæ˜¯ç”¨volatileå…³é”®å­—è¿›è¡Œä¿®é¥°è¿™ä¿è¯äº†å¯è§æ€§ï¼›é˜²æ­¢äº†æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>

<ul>
  <li>1ã€Unsafeã€‚æ˜¯CASçš„æ ¸å¿ƒç±»ï¼Œç”±äºJavaæ–¹æ³•æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆnativeï¼‰æ–¹æ³•æ¥è®¿é—®ï¼ŒUnsafeç›¸å½“äºä¸€ä¸ªåé—¨ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®ã€‚Unsafeç±»å­˜åœ¨äºsun.miscåŒ…ä¸­ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œå¯ä»¥åƒCæŒ‡é’ˆä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ã€‚</li>
  <li>2ã€ä¿è¯åŸå­æ€§çš„atmicIntegerä¸­çš„incrementAndGetæ–¹æ³•ä¸­ä½¿ç”¨äº†Unsafeçš„getAndAddIntæ–¹æ³•ï¼ŒåŒ…å«ä¸‰ä¸ªå‚æ•°ï¼ŒthisæŒ‡å½“å‰æ“ä½œå¯¹è±¡ï¼ŒvalueOffsetè¡¨ç¤ºè¯¥å˜é‡å€¼åœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œå› ä¸ºUnsafeå°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€å»è·å–æ•°æ®çš„ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯å¢åŠ å€¼ï¼Œå›ºå®šä¸º1ã€‚</li>
  <li>3ã€åœ¨compareAndSwapIntæ–¹æ³•ä¸­ï¼Œvar1å°±æ˜¯AtomicIntegerå¯¹è±¡æœ¬èº«ï¼Œvar2æ˜¯è¯¥å¯¹è±¡å€¼çš„å¼•ç”¨åœ°å€ï¼Œvar4æ˜¯æŒ‡éœ€è¦å˜åŠ¨çš„æ•°é‡ï¼Œè€Œvar5æŒ‡çš„æ˜¯ç”¨var1ã€var2æ‰¾å‡ºçš„ä¸»å†…å­˜ä¸­çœŸå®çš„å€¼ã€‚ç”¨è¯¥å¯¹è±¡å½“å‰çš„å€¼ä¸var5ï¼ˆä¹Ÿå°±æ˜¯é¢„æœŸå€¼ï¼‰æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™æ›´æ–°å€¼å¹¶è¿”å›trueï¼Œå¦‚æœä¸åŒï¼Œç»§ç»­å–å€¼ç„¶åå†æ¯”è¾ƒï¼Œç›´è‡³æ›´æ–°å®Œæˆã€‚</li>
  <li>4ã€å˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚</li>
</ul>

<h3 id="casä¸synchronizedbæ¯”å¯¹">CASä¸synchronizedbæ¯”å¯¹</h3>

<ul>
  <li>synchronizedæ˜¯å±äºç‹¬å èµ„æºï¼ŒåŒä¸€æ—¶é—´æ®µåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥è®¿é—®ï¼Œä¸€è‡´æ€§å¾—åˆ°äº†ä¿éšœï¼Œä½†æ˜¯å¹¶å‘æ€§ä¸‹é™ã€‚</li>
  <li>CASå¹¶æ²¡æœ‰åŠ é”è€Œæ˜¯è¿›è¡Œå¤šæ¬¡åœ°å–å€¼å¹¶æ¯”è¾ƒï¼Œè¿™æ ·æ—¢ä¿éšœäº†ä¸€è‡´æ€§ï¼Œåˆæé«˜äº†å¹¶å‘æ€§ã€‚</li>
</ul>

<h3 id="caså¦‚ä½•ä¿è¯åŸå­æ€§">CASå¦‚ä½•ä¿è¯åŸå­æ€§</h3>

<p>è¿™é‡Œæˆ‘ä»¬å…ˆå›å·²ä¸€ä¸‹CASçš„æ€æƒ³ï¼š</p>

<p>å®ƒé¦–å…ˆä¼šå°†<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>ä¸<code class="language-plaintext highlighter-rouge">æ—§å€¼A</code>è¿›è¡Œæ¯”è¾ƒï¼›å¦‚æœä¸€æ ·å°±ä¼šå°†<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>ä¿®æ”¹ä¸º<code class="language-plaintext highlighter-rouge">è¦ä¿®æ”¹çš„æ–°å€¼B</code>ï¼›å¦‚æœä¸ä¸€æ ·åˆ™å°±è¯´æ˜åŒä¸€æ—¶åˆ»è¯¥å€¼è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œæ­¤æ—¶ä¼šå°†<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>æ›´æ–°åˆ°<code class="language-plaintext highlighter-rouge">æ—§å€¼A</code>ï¼›ç„¶åç»§ç»­ä¸‹é¢å¾ªç¯æ¯”è¾ƒå·¥ä½œï¼Œç›´è‡³æˆåŠŸã€‚</p>

<p>è¿™é‡Œå…¶å®å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨è¿›è¡Œ<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>ä¸<code class="language-plaintext highlighter-rouge">æ—§å€¼A</code>è¿›è¡Œæ¯”è¾ƒçš„æ—¶å€™é€šè¿‡ï¼Œå½“éœ€è¦ä¿®æ”¹çš„å‰ä¸€æ—¶åˆ»ï¼Œ<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>å†…å­˜ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–ï¼›è¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚æ‰€ä»¥CASä¿è¯äº†è¿™ä¸ªæ¯”è¾ƒä¸æ›´æ–°çš„è¿‡ç¨‹æ˜¯åŸå­æ€§çš„ï¼›è¿™æ ·å°±ä¼šçº¿ç¨‹å®‰å…¨ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">é‚£ä¹ˆCASå¦‚ä½•ä¿è¯åŸå­æ€§ï¼Ÿè¿™é‡Œç®€å•è¯´ä¸‹</code></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndAddInt</span><span class="o">(</span><span class="nc">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">long</span> <span class="n">var2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">var5</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="n">var5</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getIntVolatile</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
	<span class="c1">// CASçš„å®ç°å°±æ˜¯	compareAndSwapIntæ–¹æ³•ï¼›æ­¤æ–¹æ³•æ˜¯nativeæ–¹æ³•</span>
    <span class="o">}</span> <span class="k">while</span><span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">,</span> <span class="n">var5</span><span class="o">,</span> <span class="n">var5</span> <span class="o">+</span> <span class="n">var4</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">var5</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>æ‰€ä»¥è¯´è¿™é‡Œä¿è¯åŸå­æ€§å°±åœ¨æœ¬åœ°æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯C++è¿›è¡Œå®ç°çš„ï¼›å†åº•å±‚çš„æœ€ç»ˆå®ç°æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">lock cmpxchg æŒ‡ä»¤</code>ï¼›å…¶ä¸­<code class="language-plaintext highlighter-rouge">lock</code>æ˜¯ä¸€ä¸ªé”æ€»çº¿çš„ä¸€ä¸ªé”ï¼›ä¿è¯äº†å¤šæ ¸CPUä¸‹çš„æŒ‡ä»¤åŒæ­¥ã€‚</p>

<h3 id="casç¼ºç‚¹">CASç¼ºç‚¹</h3>

<ul>
  <li>å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¾ˆå¤§ã€‚å¦‚æœCASå¤±è´¥ï¼Œä¼šä¸€ç›´è¿›è¡Œå°è¯•ï¼Œå¦‚æœé•¿æ—¶é—´ä¸€ç›´ä¸æˆåŠŸï¼Œå¯èƒ½ä¼šç»™CPUå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ã€‚</li>
  <li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œã€‚</li>
  <li>å¼•å‘ABAé—®é¢˜</li>
</ul>

<h3 id="abaé—®é¢˜">ABAé—®é¢˜</h3>

<p><strong>ä½•ä¸ºABAé—®é¢˜ï¼Ÿ</strong>
å¦‚æœä¸€ä¸ª<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯Aï¼Œå½“æˆ‘ä»¬åœ¨å‡†å¤‡æ›´æ–°çš„æ—¶å€™æ£€æŸ¥å®ƒçš„å€¼è¿˜æ˜¯Aï¼Œåœ¨åˆæ¬¡è¯»å–åˆ°å¼€å§‹æ£€æŸ¥ä¹‹å‰æˆ‘ä»¬ä¸èƒ½ç¡®ä¿<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>æœ‰æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æ”¹è¿‡ï¼</p>

<p>å› ä¸ºåœ¨è¿™æ®µæ—¶é—´å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªçº¿ç¨‹å°†<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>å…ˆæ”¹æˆBï¼Œç„¶ååˆæ”¹æˆäº†Aï¼›é‚£ä¹ˆCASåœ¨å‰é¢çš„æ“ä½œå°±ä¼šè®¤ä¸º<code class="language-plaintext highlighter-rouge">å†…å­˜ä¸­çš„å€¼V</code>ä¸€ç›´æ²¡æœ‰å˜è¿‡ï¼›è¿™ä¸ªå°±æ˜¯ABAé—®é¢˜ã€‚
<strong>ä»£ç æ¨¡æ‹ŸABA</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicTest</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">19</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">AtomicTest</span> <span class="n">thread01</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicTest</span><span class="o">();</span>
        <span class="n">thread01</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">//  è®¾ç½®è´¦æˆ·åˆå§‹å€¼å°äº20ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦è¢«å……å€¼çš„å®¢æˆ·</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¸»çº¿ç¨‹å°†19å…ˆä¿®æ”¹20ï¼š"</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="mi">20</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¸»çº¿ç¨‹å°†20åˆä¿®æ”¹19ï¼š"</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">19</span><span class="o">));</span>
        <span class="n">thread01</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"atomicIntegeræœ€ç»ˆç»“æœï¼š"</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹å°†19ä¿®æ”¹21ï¼š"</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="mi">21</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//ç¨‹åºè¾“å‡ºï¼š</span>
<span class="n">ä¸»çº¿ç¨‹å°†19å…ˆä¿®æ”¹20</span><span class="err">ï¼š</span><span class="kc">true</span>
<span class="n">ä¸»çº¿ç¨‹å°†20åˆä¿®æ”¹19</span><span class="err">ï¼š</span><span class="kc">true</span>
<span class="n">å­çº¿ç¨‹å°†19ä¿®æ”¹21</span><span class="err">ï¼š</span><span class="kc">true</span>
<span class="n">atomicIntegeræœ€ç»ˆç»“æœ</span><span class="err">ï¼š</span><span class="mi">21</span>
</code></pre></div></div>

<p>å¦‚æœéœ€è¦è§£å†³ABAé—®é¢˜ï¼ŒåŸå­å¼•ç”¨ç±»æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„ç±» - <code class="language-plaintext highlighter-rouge">AtomicStampedReference</code>;æˆ–è€…æ”¹ç”¨ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥ï¼ˆå…¸å‹çš„å°±æ˜¯synchronized å’ŒLockï¼‰å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆã€‚</p>

<h3 id="atomicstampedreference">AtomicStampedReference</h3>

<p>AtomicStampedReferenceå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªstampç‰ˆæœ¬å·ï¼Œä¸»è¦ç”¨æ¥è§£å†³ABAé—®é¢˜ã€‚</p>

<p><strong>ç¤ºä¾‹ä»£ç </strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicTest</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">AtomicStampedReference</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">atomicStampedReference</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">AtomicTest</span> <span class="n">thread01</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicTest</span><span class="o">();</span>
        <span class="n">thread01</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¸»çº¿ç¨‹å°†AtomicStampedReference(1,1)ä¿®æ”¹ä¸º(2,2)ï¼š"</span> <span class="o">+</span>
                <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¸»çº¿ç¨‹å°†AtomicStampedReference(2,2)åˆä¿®æ”¹(1,3)ï¼š"</span> <span class="o">+</span>
                <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>


        <span class="n">thread01</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹è·å–AtomicStampedReferenceç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹å°†AtomicStampedReference(1,1)ä¿®æ”¹(3,2)ï¼š"</span> <span class="o">+</span>
                    <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹è·å–AtomicStampedReferenceå®é™…ç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//ç¨‹åºè¾“å‡ºï¼š</span>
<span class="n">å­çº¿ç¨‹è·å–AtomicStampedReferenceç‰ˆæœ¬å·</span><span class="err">ï¼š</span><span class="mi">1</span>
<span class="n">ä¸»çº¿ç¨‹å°†AtomicStampedReference</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span><span class="n">ä¿®æ”¹ä¸º</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span><span class="err">ï¼š</span><span class="kc">true</span>
<span class="n">ä¸»çº¿ç¨‹å°†AtomicStampedReference</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span><span class="n">åˆä¿®æ”¹</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span><span class="err">ï¼š</span><span class="kc">true</span>
<span class="n">å­çº¿ç¨‹å°†AtomicStampedReference</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span><span class="n">ä¿®æ”¹</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span><span class="err">ï¼š</span><span class="kc">false</span>
<span class="n">å­çº¿ç¨‹è·å–AtomicStampedReferenceå®é™…ç‰ˆæœ¬å·</span><span class="err">ï¼š</span><span class="mi">3</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">AtomicStampedReferenceå†…å­˜éœ€è¦è‡ªå·±æ‰‹åŠ¨å»ç»´æŠ¤è¿™ä¸ªç‰ˆæœ¬å·stampï¼›å¦‚æœç‰ˆæœ¬å·ç»´æŠ¤çš„æœ‰é—®é¢˜ï¼ˆç±»ä¼¼å€¼å˜åŒ–çš„é—®é¢˜ï¼‰å…¶å®ä¾æ—§ä¹Ÿä¼šå‡ºç°ABAé—®é¢˜ï¼›æ‰€ä»¥æ³¨æ„ç‰ˆæœ¬å·çš„ç»´æŠ¤ï¼ŒAtomicStampedReferenceå…¶å®æ˜¯æŠŠABAé—®é¢˜äº¤ç”±æˆ‘ä»¬å¼€å‘äººå‘˜è‡ªå·±å»æ§åˆ¶äº†</code></p>

<p>AtomicReference<T>å…¶å®å°±æ˜¯ä¸AtomicIntegerå†…éƒ¨å®ç°ä¸€æ ·ï¼Œåªä¸è¿‡AtomicReference<T>è‡ªå·±å®šä¹‰æ³›å‹ï¼ŒAtomicStampedReference<T>å°±æ˜¯å¸¦ç‰ˆæœ¬å·çš„è‡ªå·±å®šä¹‰æ³›å‹ï¼›</T></T></T></p>
:ET